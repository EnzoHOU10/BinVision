<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>BinVision - Home</title>
    <link rel="icon" href="../static/logo/logo.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/css/style.css" />
  </head>

  <body>
    <div class="sidebar">
      <div id="start">
        <img src="../static/logo/logoname.ico" alt="Chargement..." id="startlogo" />
      </div>
      <a href="/" data-icon="üè†"><strong>Home</strong></a>
      <a href="/predict" data-icon="üîç">Pleine/Vide</a>
      {% if user and user.role == 'admin' %}
      <a href="/admin" data-icon="‚öôÔ∏è">Settings</a>
      {% endif %}
      <a href="/dashboard" data-icon="üìä">Dashboard</a>
      <div id="end">
        <p>All rights reserved</p>
        <p>¬© 2024 BinVision</p>
        <p>Version 1.0.0</p>
      </div>
    </div>
    <div class="btnright">
      <a href="/account" class="btn">Account</a>
    </div>
    <div class="content">
      <h3>IA ‚Äì Suivi en temps r√©el avec Google Maps</h3>
      <div class="d-flex flex-wrap flex-md-nowrap" style="gap:2vw;">
        <div id="map"></div>
        <div id="sidebar2">
          <h5>Filtres</h5>
          <div class="filter-box">
            <input type="checkbox" id="show_population" checked />
            <label for="show_population">Population</label><br />
            <input type="checkbox" id="show_meteo" checked />
            <label for="show_meteo">M√©t√©o</label><br />
            <input type="checkbox" id="show_btp" checked />
            <label for="show_btp">Travaux BTP</label><br />
            <input type="checkbox" id="show_market" checked />
            <label for="show_market">Jours de march√©</label><br />
          </div>
          <h5>Journal des mises √† jour</h5>
          <ul id="log" style="list-style-type: none; padding-left: 0"></ul>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="../static/js/script.js"></script>
    <script
      async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxFrv8bluwrce-EQuMBmAhlhzfNXbTvCA&callback=initMap"
    ></script>
    <script>
      let map;
      const markers = {};
      const images = {{ images|tojson }};
      let directionsService;
      let directionsRenderer;
      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 48.8566, lng: 2.3522 },
          zoom: 13,
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);

        const socket = io();

        images.forEach((img) => {
          if (!document.getElementById("show_population").checked && img.population) return;
          if (!document.getElementById("show_btp").checked && img.btp) return;
          if (!document.getElementById("show_meteo").checked && img.meteo) return;
          if (!document.getElementById("show_market").checked && img.market) return;

          const contentString = `
            <div><strong>ID:</strong> ${img.id}</div>
            <div><strong>Population:</strong> ${img.population || "N/A"}</div>
            <div><strong>M√©t√©o:</strong> ${img.meteo || "N/A"}</div>
            <div><strong>Jour:</strong> ${img.jour || "?"}</div>
            <div><strong>Travaux:</strong> ${img.btp ? "Oui" : "Non"}</div>
            <div><strong>March√©:</strong> ${img.market ? "Oui" : "Non"}</div>
            <div><strong>Date acquisition:</strong> ${img.date_acquisition || "?"}</div>
          `;

          const infowindow = new google.maps.InfoWindow({ content: contentString });

          const marker = new google.maps.Marker({
            position: { lat: parseFloat(img.lat), lng: parseFloat(img.lng) },
            map,
            title: `Poubelle ${img.id}`,
            icon: {
              url: "../static/icons/bin.png",
              scaledSize: new google.maps.Size(32, 32),
            },
          });

          marker.addListener("mouseover", () => infowindow.open(map, marker));
          marker.addListener("mouseout", () => infowindow.close());
          markers[img.id] = marker;
          marker.addListener("click", () => {
            if (userPosition) {
              calculateRoute(userPosition, marker.getPosition());
            } else {
              alert("Position actuelle non disponible.");
            }
          });

          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                userPosition = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                };

                new google.maps.Marker({
                  position: userPosition,
                  map,
                  title: "Ma position",
                  icon: {
                    url: "../static/icons/cleaner.png",
                    scaledSize: new google.maps.Size(32, 32),
                  },
                });

                map.setCenter(userPosition);
              },
              () => {
                alert("Impossible de r√©cup√©rer la position actuelle.");
              }
            );
          } else {
            alert("G√©olocalisation non support√©e par ce navigateur.");
          }
        });
      }
      function calculateRoute(origin, destination) {
        const request = {
          origin,
          destination,
          travelMode: google.maps.TravelMode.WALKING,
        };

        directionsService.route(request, (result, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(result);
          } else {
            alert("Erreur lors du calcul de l‚Äôitin√©raire : " + status);
          }
        });
      }

      let userPosition = null;
    </script>
  </body>
</html>
