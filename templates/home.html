<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>BinVision - Home</title>
    <link rel="icon" href="../static/logo/logo.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../static/css/style.css" />
    <style>
      .d-flex { height: 75vh; width: 90%; margin: 0 auto; }
      #map { height: 100%; width: 70%; border-radius: 10px 0 0 10px; }
      #sidebar2 {
        flex: 1;
        padding: 1rem;
        border-left: 10px solid #500000;
        background-color: rgba(255, 0, 0, 0.1);
        border-radius: 0 10px 10px 0;
        overflow-y: auto;
      }
      .filter-box { margin-bottom: 10px; }
    </style>
  </head>

  <body>
    <div class="sidebar">
      <div id="start"><img src="../static/logo/logoname.ico" alt="Chargement..." width="60%" id="startlogo" /></div>
      <br />
      <a href="/home"><strong>Home</strong></a>
      <a href="/predict">Pleine/Vide</a>
      <a href="/">Settings</a>
      <a href="/dashboard">Dashboard</a>
      <div id="end">
        <p>All rights reserved</p>
        <p>© 2024 BinVision</p>
        <p>Version 1.0.0</p>
      </div>
    </div>

    <div class="content">
      <h3>IA – Suivi en temps réel avec Google Maps</h3>
      <div class="d-flex">
        <div id="map"></div>
        <div id="sidebar2">
          <h5>Filtres</h5>
          <div class="filter-box">
            <input type="checkbox" id="show_population" checked /> <label for="show_population">Population</label><br />
            <input type="checkbox" id="show_meteo" checked /> <label for="show_meteo">Météo</label><br />
            <input type="checkbox" id="show_btp" checked /> <label for="show_btp">Travaux BTP</label><br />
            <input type="checkbox" id="show_market" checked /> <label for="show_market">Jours de marché</label><br />
          </div>

          <h5>Journal des mises à jour</h5>
          <ul id="log" style="list-style-type: none; padding-left: 0;"></ul>
        </div>
      </div>
      <div class="text-center mt-3">
        <button class="btn btn-outline-danger" onclick="showSeuils()">Ajuster l'IA</button>
      </div>
    </div>

    <div class="seuils" style="display: none;">
      <!-- ... Ton formulaire de réglage IA reste inchangé ... -->
      <div class="text-center margin-top">
        <button class="btn" onclick="hideSeuils()">Retour</button>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="../static/js/script.js"></script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB820As-PrA-MYsS6l9Yr2fQqD4T6c5XqU&callback=initMap"></script>
    <script>
      let map;
      const markers = {};
      const images = {{ images|tojson }};
      let directionsService;
      let directionsRenderer;
      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 48.8566, lng: 2.3522 },
          zoom: 13,
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);

        const socket = io();

        images.forEach((img) => {
          if (!document.getElementById("show_population").checked && img.population) return;
          if (!document.getElementById("show_btp").checked && img.btp) return;
          if (!document.getElementById("show_meteo").checked && img.meteo) return;
          if (!document.getElementById("show_market").checked && img.market) return;

          const contentString = `
            <div><strong>ID:</strong> ${img.id}</div>
            <div><strong>Population:</strong> ${img.population || "N/A"}</div>
            <div><strong>Météo:</strong> ${img.meteo || "N/A"}</div>
            <div><strong>Jour:</strong> ${img.jour || "?"}</div>
            <div><strong>Travaux:</strong> ${img.btp ? "Oui" : "Non"}</div>
            <div><strong>Marché:</strong> ${img.market ? "Oui" : "Non"}</div>
            <div><strong>Date acquisition:</strong> ${img.date_acquisition || "?"}</div>
          `;

          const infowindow = new google.maps.InfoWindow({ content: contentString });

          const marker = new google.maps.Marker({
            position: { lat: parseFloat(img.lat), lng: parseFloat(img.lng) },
            map,
            title: `Poubelle ${img.id}`,
            icon: {
              url: "../static/icons/bin.png",
              scaledSize: new google.maps.Size(32, 32),
            },
          });

          marker.addListener("mouseover", () => infowindow.open(map, marker));
          marker.addListener("mouseout", () => infowindow.close());
          markers[img.id] = marker;
          marker.addListener("click", () => {
            if (userPosition) {
              calculateRoute(userPosition, marker.getPosition());
            } else {
              alert("Position actuelle non disponible.");
            }
          });

          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                userPosition = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                };

                new google.maps.Marker({
                  position: userPosition,
                  map,
                  title: "Ma position",
                  icon: {
                    url: "../static/icons/cleaner.png",
                    scaledSize: new google.maps.Size(32, 32),
                  },
                });

                map.setCenter(userPosition);
              },
              () => {
                alert("Impossible de récupérer la position actuelle.");
              }
            );
          } else {
            alert("Géolocalisation non supportée par ce navigateur.");
          }
        });
      }
      function calculateRoute(origin, destination) {
        const request = {
          origin,
          destination,
          travelMode: google.maps.TravelMode.WALKING, // ou DRIVING
        };

        directionsService.route(request, (result, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(result);
          } else {
            alert("Erreur lors du calcul de l’itinéraire : " + status);
          }
        });
      }

      let userPosition = null;

      function showSeuils() {
        document.querySelector(".seuils").style.display = "block";
        document.querySelector(".content").style.display = "none";
      }

      function hideSeuils() {
        document.querySelector(".seuils").style.display = "none";
        document.querySelector(".content").style.display = "block";
      }
    </script>
  </body>
</html>
