<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>BinVision</title>
  </head>
  <body>
    <h1>Upload une image</h1>
    <a href="/rules">ðŸ”§ Configurer les rÃ¨gles de classification</a>
    <form method="POST" id="Form" enctype="multipart/form-data">
      <input
        type="file"
        id="input"
        name="image"
        accept=".png,.jpg,.jpeg"
        multiple
        required
      />
      <div id="preview"></div>
      <p>Choisir une annotation :</p>
      <div id="annotation-buttons" style="display: flex; gap: 10px; margin-bottom: 10px">
        <button type="button" onclick="annotation('Pleine')">Pleine</button>
        <button type="button" onclick="annotation('Vide')">Vide</button>
        <button type="button" onclick="annotation('Auto')">Auto</button>
      </div>
    </form>

    <h2>Images enregistrÃ©es :</h2>
    <ul>
      {% for img in images %}
      <li>
        <img
          src="{{ url_for('uploaded_file', filename=img.filename) }}"
          width="100"
        /><br />
        {{ img.filename }} â€“ {{ img.annotation }}<br />
        Taille: {{ img.filesize_kb }} KB â€“ Dimensions: {{ img.width }}x{{
        img.height }} â€“ Moy. RGB: ({{ img.avg_color_r }}, {{ img.avg_color_g }},
        {{ img.avg_color_b }})
      </li>
      {% endfor %}
    </ul>
  </body>
  <script>
    let files = [];
    let currentIndex = 0;

    document.getElementById('input').addEventListener("change", function (e) {
      files = Array.from(e.target.files);
      currentIndex = 0;
      showCurrentImage();
    });

    function showCurrentImage() {
      const preview = document.getElementById("preview");
      preview.innerHTML = '';
      if (currentIndex < files.length) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(files[currentIndex]);
        img.style.maxWidth = "200px";
        img.style.maxHeight = "200px";
        preview.appendChild(img);
      } else {
        location.reload();
      }
    }

    function annotation(annotation) {
      if (currentIndex >= files.length) return;
      const formData = new FormData();
      formData.append("image", files[currentIndex]);
      formData.append("annotation", annotation);
      fetch("/", {
        method: "POST",
        body: formData,
      })
        .then((res) => {
          if (!res.ok) throw new Error("Erreur serveur");
          currentIndex++;
          showCurrentImage();
        })
        .catch((err) => alert("Erreur lors de l'envoi : " + err.message));
    }
  </script>
</html>
